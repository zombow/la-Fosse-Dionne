# logic.py
import re
from utils import request_gemini, load_pdfs_from_local

# ğŸ’¾ ì‚¬ìš©ìë³„ ëŒ€í™” íˆìŠ¤í† ë¦¬ ë° ìƒíƒœ ì €ì¥
message_histories = {}  # user_id â†’ message history
user_states = {}  # user_id â†’ (trait, gold, exp)
user_story_active = {}  # user_id â†’ ì¸ì¹´ìš´í„° ì§„í–‰ ì¤‘ ì—¬ë¶€
user_current_scenario = {}  # user_id â†’ í˜„ì¬ ì‹œë‚˜ë¦¬ì˜¤ í…ìŠ¤íŠ¸ ì €ì¥

# ğŸ“š ì „ì—­ ì°¸ì¡° ë¬¸ì„œ ë‚´ìš©
GLOBAL_RAG_CONTENT = ""
last_result_cache = {}
last_user_choice = {}

def extract_relevant_block(text, number):
    pattern = rf"### ì„ íƒì§€:\s*(?:.*\n)*?\n*{number}\. .*\n"
    match = re.search(pattern, text)
    return match.group(0) if match else text

def init_rag_context():
    """
    ì„œë²„ ì‹œì‘ ì‹œ PDF í´ë”ì—ì„œ ë¬¸ì„œ ë‚´ìš©ì„ ë¡œë”©í•˜ì—¬ ì „ì—­ ìƒíƒœì— ì €ì¥
    """
    global GLOBAL_RAG_CONTENT
    GLOBAL_RAG_CONTENT = load_pdfs_from_local("pdfs")

def extract_scores(user_id: str, text: str):
    """
    ì‘ë‹µ í…ìŠ¤íŠ¸ì—ì„œ ì„±í–¥ê°’/ê³¨ë“œ/ê²½í—˜ì¹˜ ì¶”ì¶œ í›„ ì €ì¥
    """
    trait = gold = exp = None

    trait_match = re.search(r"ì„±í–¥ê°’\s*[:ï¼š]\s*([+-]?\d+\.?\d*)", text)
    if trait_match:
        try:
            trait = float(trait_match.group(1))
        except ValueError:
            pass

    gold_match = re.search(r"ê³¨ë“œ\s*[:ï¼š]\s*(\d+)", text)
    if gold_match:
        try:
            gold = int(gold_match.group(1))
        except ValueError:
            pass

    exp_match = re.search(r"ê²½í—˜ì¹˜\s*[:ï¼š]\s*(\d+)", text)
    if exp_match:
        try:
            exp = int(exp_match.group(1))
        except ValueError:
            pass

    user_states[user_id] = (trait, gold, exp)

def process_user_message(user_id: str, message: str):
    result = ""  # result ë³€ìˆ˜ë¥¼ ì´ˆê¸°í™”í•˜ì—¬ UnboundLocalError ë°©ì§€

    print(f"ğŸ“¨ [USER:{user_id}] ì…ë ¥ ë©”ì‹œì§€: {message}")

    if user_id not in message_histories:
        message_histories[user_id] = []
        user_story_active[user_id] = False
        user_current_scenario[user_id] = ""

    history = message_histories[user_id]

    if message.strip().lower() in ["ëœë¤ ì¸ì¹´ìš´í„°", "ì‹œì‘", "ì¸ì¹´ìš´í„°"]:
        user_story_active[user_id] = True
        history.clear()  # ê¸°ì¡´ íˆìŠ¤í† ë¦¬ ì™„ì „ ì‚­ì œ
        user_current_scenario[user_id] = ""  # í˜„ì¬ ì‹œë‚˜ë¦¬ì˜¤ë„ ì´ˆê¸°í™”
        
        # ìƒˆë¡œìš´ ê²Œì„ ë§ˆìŠ¤í„° ì—­í•  ì„¤ì •
        system_prompt = {
            "role": "user",
            "content": (
                "ë„ˆëŠ” ì¤‘ì„¸ íŒíƒ€ì§€ RPG ì¸ì¹´ìš´í„°ë¥¼ ì´ë„ëŠ” ê²Œì„ ë§ˆìŠ¤í„°ì´ë‹¤. "
                "ì‚¬ìš©ìì™€ì˜ ìƒí˜¸ì‘ìš©ì„ í†µí•´ ì§§ê³  ìœ í•œí•œ ì´ì•¼ê¸°ì˜ íë¦„ì„ êµ¬ì„±í•˜ê³ , ì„ íƒì§€ ê¸°ë°˜ìœ¼ë¡œ ê°ˆë“± ë˜ëŠ” ë³´ìƒì„ ì œê³µí•´ì•¼ í•œë‹¤."
            )
        }
        history.append(system_prompt)
        
        prompt = f"""íŒíƒ€ì§€ ì„¸ê³„ë¥¼ ë°°ê²½ìœ¼ë¡œ í•œ ëœë¤ ì¸ì¹´ìš´í„°ë¥¼ í•˜ë‚˜ ìƒì„±í•´.
        [ì¡°ê±´]
        - ì¥ì†Œ: ë§ˆì„, ìˆ², íí—ˆ, ë™êµ´ ë“± ë‹¤ì–‘í•œ í™˜ê²½ ì¤‘ í•˜ë‚˜
        - ë“±ì¥ì¸ë¬¼ ë˜ëŠ” ì¡´ì¬: ì¸ê°„, ì˜¤í¬, ì—˜í”„, ë“œì›Œí”„, ì •ë ¹, ê´´ë¬¼ ë“±
        - ì‚¬ê±´ ìœ í˜•: ë§¤ë³µ, êµ¬ì¡° ìš”ì²­, ë¹„ë°€ ê±°ë˜, ì €ì£¼, ì „ì—¼ë³‘ ë“±
        - í”Œë ˆì´ì–´ê°€ ì·¨í•  ìˆ˜ ìˆëŠ” ì„ íƒì§€ë¥¼ ìµœì†Œ 3ê°œ ì´ìƒ í¬í•¨
        - ì„ íƒì— ë”°ë¼ ê²°ê³¼ê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆë„ë¡ ë§Œë“¤ì–´ì¤˜ (ê°ˆë“± or ë³´ìƒ ì¤‘ì‹¬)
        - í”Œë ˆì´ì–´ê°€ ì–´ë”˜ê°€ì— ì–µì••ë˜ê±°ë‚˜ ê°‡íˆê²Œ ë§Œë“¤ë©´ ì•ˆëœë‹¤.
        - ë¬´ì–¸ê°€ ë¬¼ê±´ì„ ì–»ê²Œ ë˜ê±°ë‚˜ ìƒê²Œí•´ì„œëŠ” ì•ˆëœë‹¤.
        - í­ë ¥ì ì¸ ë¬˜ì‚¬ë‚˜ ìí•´ ìš”ì†Œ, ì–µì••í•˜ëŠ” ë¬˜ì‚¬ëŠ” ì ˆëŒ€ ë„£ì§€ë§ˆ
        - ì„ íƒì§€ ì•„ë˜ì—ëŠ” ì ˆëŒ€ ì‚¬ê²¬, í‰ê°€, ë¶€ì—° ì„¤ëª…ì„ ë„£ì§€ ë§ ê²ƒ.

        [í˜•ì‹]
        - ì œëª©
        - ì¥ì†Œ ì„¤ëª…
        - ë“±ì¥ ì¸ë¬¼/ì¡´ì¬
        - ìƒí™© ì„¤ëª…
        - ì„ íƒì§€

        ì°¸ê³  ë¬¸ì„œ ë‚´ìš©ì„ ì°¸ê³ í•´ì„œ ë§Œë“¤ì–´. ë‹¨, ë¬¸ì„œ ë‚´ìš©ì˜ ì„¸ê³„ê´€ì€ ì°¸ê³ í•˜ë˜ ì£¼ìš” ìŠ¤í† ë¦¬ì™€ ì—°ê´€ ì—†ì´ ë§Œë“¤ì–´.
        ---
        ì°¸ê³  ë¬¸ì„œ ë‚´ìš©:
        {GLOBAL_RAG_CONTENT}
        ---

        **í˜•ì‹ì„ ë”°ë¥´ë˜ ì ˆëŒ€ í˜•ì‹ ì œëª©ì€ ë‚˜íƒ€ë‚´ì§€ ì•Šê³  ì´ì•¼ê¸° í•˜ë“¯ í’€ì–´ë‚´. í•˜ì§€ë§Œ ì„ íƒì§€ ì•„ë˜ë¡œëŠ” ì‚¬ê²¬ì„ ë¶™ì´ì§€ ë§ˆ.**  
        **ì„ íƒì§€ì— ë”°ë¥¸ ê²°ê³¼ëŠ” ë³´ì´ì§€ ì•Šê²Œ í•´ì¤˜. ì „íˆ¬ ê´€ë ¨ëœ ì„ íƒì§€ëŠ” ë‚˜ì˜¤ì§€ ì•Šê²Œ í•´ì•¼ í•´.**  
        **ì¸ì¹´ìš´í„°ì˜ ê¸¸ì´ê°€ ì§§ê²Œ ë§Œë“¤ì–´ì¤˜**
        **ì„ íƒì§€ë¥¼ ì œì‹œí•˜ê³  ë‚˜ì„œ ì–´ë–¤ ê²°ê³¼ë„ ì¶œë ¥í•˜ì§€ ë§ˆ.**
        **ì„ íƒ ê²°ê³¼ê°€ ì…ë ¥ë˜ê¸° ì „ì—ëŠ” ì ˆëŒ€ ì¸ì¹´ìš´í„° ì¢…ë£Œ, ì„±í–¥ê°’, ê³¨ë“œë¥¼ ì¶œë ¥í•˜ì§€ ë§ˆ.**
        **ê²°ê³¼ê°€ ì¶œë ¥ë˜ì§€ ì•ŠëŠ” ê²½ìš°ì—ëŠ” ì ˆëŒ€ 'ì¸ì¹´ìš´í„° ì¢…ë£Œ'ë‚˜ ì„±í–¥ê°’, ê³¨ë“œë¥¼ ì¶œë ¥í•˜ì§€ ì•ŠëŠ”ë‹¤. ì ˆëŒ€ ì¤‘ê°„ì— ì¶œë ¥í•˜ì§€ ì•ŠëŠ”ë‹¤.**
        **ì¸ì¹´ìš´í„°ê°€ ì¢…ë£Œë˜ëŠ” ë§ˆì§€ë§‰ í„´ì—ë§Œ 'ì¸ì¹´ìš´í„° ì¢…ë£Œ'ë¥¼ ë§¨ ë§ˆì§€ë§‰ ì¤„ì— ì“°ê³ , ê·¸ ë°”ë¡œ ì•„ë˜ ì¤„ì— 'ì„±í–¥ê°’: +1' í˜•íƒœë¡œ -1, 0, 1 ì…‹ ì¤‘ í•˜ë‚˜ë¥¼ íŒë³„í•˜ì—¬ ì¶œë ¥í•˜ë¼. ë˜í•œ ê³¨ë“œë„ 'ê³¨ë“œ: 15' í˜•íƒœë¡œ 10~20 ì‚¬ì´ì˜ ìˆ˜ë¥¼ ì…ë ¥í•´ë¼**
        **ë˜í•œ 'ê²½í—˜ì¹˜: 3' í˜•íƒœë¡œ 1ì—ì„œ 5 ì‚¬ì´ì˜ ìˆ«ìë¥¼ ëœë¤ìœ¼ë¡œ ì¶œë ¥í•˜ë¼**

        **ì„ íƒì§€ë¥¼ 1. [ì„ íƒì§€1], 2. [ì„ íƒì§€2], 3. [ì„ íƒì§€3]ê³¼ ê°™ì´ ë²ˆí˜¸ ë§¤ê²¨ì„œ ì œê³µí•´ì¤˜. ê° ì„ íƒì§€ëŠ” í•œ ì¤„ë¡œ ëë‚˜ì•¼ í•´.**
        **ë§Œì•½ í”Œë ˆì´ì–´ê°€ íŠ¹ì • í–‰ë™ì„ í•œ í›„ ê²°ê³¼ë§Œì„ ì•Œë ¤ì¤„ ë•ŒëŠ”, '### ê²°ê³¼:'ë¡œ ì‹œì‘í•˜ëŠ” ì„¹ì…˜ ì•ˆì— ë‚´ìš©ì„ ì„œìˆ í•˜ê³ , ì´í›„ì—ëŠ” ì•„ë¬´ëŸ° ì„ íƒì§€ë„ ì œê³µí•˜ì§€ ë§ˆì„¸ìš”.**
        **ë§Œì•½ í”Œë ˆì´ì–´ê°€ ë‹¤ìŒ í–‰ë™ì„ ì„ íƒí•´ì•¼ í•  ë•ŒëŠ”, '### ì„ íƒì§€:'ë¡œ ì‹œì‘í•˜ëŠ” ì„¹ì…˜ ì•ˆì— ë²ˆí˜¸ ë§¤ê²¨ì§„ ì„ íƒì§€ ëª©ë¡ì„ ì œê³µí•˜ì„¸ìš”.**
        **ë‹¤ìŒ í–‰ë™ì— ëŒ€í•œ ì„ íƒì§€ë¥¼ ì œê³µí•  ë•ŒëŠ” ë°˜ë“œì‹œ ### ì„ íƒì§€: ë¼ëŠ” í—¤ë” ì•„ë˜ì— ë²ˆí˜¸ ë§¤ê²¨ì§„ ëª©ë¡ì„ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤. ë‹¤ë¥¸ ì–´ë–¤ ì¶”ê°€ í…ìŠ¤íŠ¸ë„ í—¤ë”ì— í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.**

        ** ì ˆëŒ€ ì—¬ëŸ¬ ë²ˆ ì„ íƒì§€ë¥¼ ì¶œë ¥í•˜ì§€ ë§ˆ. í•œ ë²ˆë§Œ! **
        ** ì ˆëŒ€ ì—¬ëŸ¬ í„´ì„ í•œ ë²ˆì— ì¶œë ¥í•˜ì§€ ë§ˆ. í˜„ì¬ ì„ íƒì— ëŒ€í•œ ê²°ê³¼ë§Œ ì¶œë ¥í•´. **
        ** ë°˜ë“œì‹œ ì§ì „ ì„ íƒì— ëŒ€í•œ ê²°ê³¼ë§Œ ì„œìˆ í•˜ë¼. ì ˆëŒ€ ìƒˆë¡œìš´ ì´ì•¼ê¸°ë¡œ ë„˜ì–´ê°€ì§€ ë§ˆë¼. **

        [NEVER DO THIS]
        - ì„ íƒì§€ë¥¼ ë‘ ë²ˆ ì´ìƒ ì¶œë ¥í•˜ì§€ ë§ˆ
        - í•œ í„´ ì´ìƒì˜ ì´ì•¼ê¸°ë¥¼ ì´ì–´ì„œ ì „ê°œí•˜ì§€ ë§ˆ
        - ì§ì „ ì„ íƒê³¼ ê´€ë ¨ ì—†ëŠ” ìƒˆ ì¸ì¹´ìš´í„°ë‚˜ ìºë¦­í„°, ì¥ì†Œ, ì„¤ì •ì„ ì†Œê°œí•˜ì§€ ë§ˆ
        - ì´ì „ ì„ íƒì§€ì™€ ë¬´ê´€í•œ ê°ˆë“±, ì¥ì†Œ ì „í™˜, ë¬´ëŒ€ í™•ì¥, ë³µì„  ì•”ì‹œ ë“±ì„ í•˜ì§€ ë§ˆ
        - ê°ì •ì ìœ¼ë¡œ ëª°ì•„ê°€ëŠ” íë¦„ì´ë‚˜ ì‹œì  í‘œí˜„, ì² í•™ì  ëŒ€ì‚¬ ë“±ì„ ì ˆëŒ€ ì“°ì§€ ë§ˆ
        - ëŒ€í™”í˜•ìœ¼ë¡œ ì¸ì¹´ìš´í„°ë¥¼ ì¢…ë£Œí•˜ì§€ ë§ˆ
        - í”Œë ˆì´ì–´ì—ê²Œ ë³´ìƒì„ ì£¼ì§€ ë§ˆ
        """
        
        history.append({"role": "user", "content": prompt})
        result = request_gemini(history)
        
        # ìƒì„±ëœ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì €ì¥
        user_current_scenario[user_id] = result
        
        # AI ì‘ë‹µë„ íˆìŠ¤í† ë¦¬ì— ì €ì¥
        history.append({"role": "assistant", "content": result})
        
        extract_scores(user_id, result)

    elif message.strip().isdigit():
        if not user_story_active.get(user_id):
            return "âš ï¸ ì„ íƒì§€ëŠ” í™œì„±í™”ëœ ì¸ì¹´ìš´í„°ê°€ ì—†ì„ ë•Œ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", None, None, None

        selected_number = message.strip()
        last_user_choice[user_id] = selected_number
        
        # í˜„ì¬ ì €ì¥ëœ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì°¸ì¡° (íˆìŠ¤í† ë¦¬ì˜ ë§ˆì§€ë§‰ AI ì‘ë‹µ)
        current_scenario = user_current_scenario.get(user_id, "")
        if not current_scenario and len(history) >= 2:
            # íˆìŠ¤í† ë¦¬ì—ì„œ ë§ˆì§€ë§‰ AI ì‘ë‹µ ì°¾ê¸°
            for i in range(len(history) - 1, -1, -1):
                if history[i].get("role") == "assistant":
                    current_scenario = history[i]["content"]
                    break

        print(f"ğŸ¯ [DEBUG] í˜„ì¬ ì‹œë‚˜ë¦¬ì˜¤: {current_scenario[:100]}...")
        print(f"ğŸ¯ [DEBUG] ì„ íƒëœ ë²ˆí˜¸: {selected_number}")

        followup_prompt = (
            f"í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì¸ì¹´ìš´í„°:\n{current_scenario}\n\n"
            f"ì‚¬ìš©ìê°€ ì„ íƒí•œ ë²ˆí˜¸ëŠ” {selected_number}ì…ë‹ˆë‹¤.\n"
            f"ìœ„ ì¸ì¹´ìš´í„°ì—ì„œ {selected_number}ë²ˆ ì„ íƒì§€ì— ëŒ€í•œ ê²°ê³¼ë§Œì„ ì‘ì„±í•˜ì„¸ìš”.\n"
            f"ì ˆëŒ€ ìƒˆë¡œìš´ ì´ì•¼ê¸°ë‚˜ ë‹¤ë¥¸ ì„¤ì •ìœ¼ë¡œ ë„˜ì–´ê°€ì§€ ë§ˆì„¸ìš”.\n"
            f"ì„ íƒ ê²°ê³¼ì— ë”°ë¼ ì¸ì¹´ìš´í„°ê°€ ì¢…ë£Œëœë‹¤ë©´ 'ì¸ì¹´ìš´í„° ì¢…ë£Œ', 'ì„±í–¥ê°’: +1', 'ê³¨ë“œ: 15', 'ê²½í—˜ì¹˜: 3' í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•˜ì„¸ìš”.\n"
            f"ê³„ì† ì´ì–´ì§„ë‹¤ë©´ ë°˜ë“œì‹œ '### ì„ íƒì§€:'ë¼ëŠ” í—¤ë” ì•„ë˜ì— ë²ˆí˜¸ ë§¤ê¸´ 3ê°œì˜ ì„ íƒì§€ë¥¼ ì œê³µí•˜ì„¸ìš”.\n"
            f"ì§ì „ ì„ íƒì— ëŒ€í•œ ì´ì•¼ê¸°ë§Œ í•˜ê³ , ì™„ì „íˆ ìƒˆë¡œìš´ ì„¤ì •ì´ë‚˜ ì¸ë¬¼ì„ ë„ì…í•˜ì§€ ë§ˆì„¸ìš”."
        )

        history.append({"role": "user", "content": followup_prompt})
        result = request_gemini(history)
        
        # ìƒˆë¡œìš´ ê²°ê³¼ë¥¼ í˜„ì¬ ì‹œë‚˜ë¦¬ì˜¤ë¡œ ì—…ë°ì´íŠ¸
        user_current_scenario[user_id] = result
        
        # AI ì‘ë‹µì„ íˆìŠ¤í† ë¦¬ì— ì €ì¥
        history.append({"role": "assistant", "content": result})
        
        extract_scores(user_id, result)

    else:
        history.append({"role": "user", "content": message})
        result = request_gemini(history)
        history.append({"role": "assistant", "content": result})
        extract_scores(user_id, result)

    if "ì¸ì¹´ìš´í„° ì¢…ë£Œ" in result:
        user_story_active[user_id] = False
        user_current_scenario[user_id] = ""  # ì‹œë‚˜ë¦¬ì˜¤ ì´ˆê¸°í™”
        last_result_cache[user_id] = result

    trait, gold, exp = user_states.get(user_id, (None, None, None))
    return result, trait, gold, exp